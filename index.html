<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JSON Card Browser — Search & Display</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f1724;--panel:#0b1220;--accent:#3b82f6;--muted:#9aa4b2;--card:#0e1620}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto; margin:0; background:linear-gradient(180deg,#071025 0%, #071427 100%); color:#e6eef6;}
    header{padding:18px;border-bottom:1px solid rgba(255,255,255,0.04);display:flex;gap:12px;align-items:center}
    h1{font-size:18px;margin:0}
    .container{display:flex;gap:16px;padding:16px}
    .left{width:360px;min-width:260px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    .right{flex:1;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;min-height:60vh}
    label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
    input[type="text"], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--accent);border:none;color:#04263f;padding:8px 10px;border-radius:8px;cursor:pointer}
    .file-info{font-size:13px;color:var(--muted);margin-top:8px}
    .result-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px;border-radius:8px;display:flex;gap:8px;align-items:center;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .thumb{width:72px;height:100px;background:#091225;border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{flex:1}
    .meta h3{margin:0;font-size:14px}
    .meta p{margin:3px 0;color:var(--muted);font-size:13px}
    .stats{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .pill{background:rgba(255,255,255,0.03);padding:4px 6px;border-radius:6px;font-size:12px;color:var(--muted)}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted)}
    .modal{position:fixed;inset:0;background:linear-gradient(rgba(3,6,12,0.6),rgba(3,6,12,0.8));display:none;align-items:center;justify-content:center;padding:20px}
    .modal .dialog{background:#071427;padding:16px;border-radius:10px;width:min(980px,98%);max-height:90vh;overflow:auto;border:1px solid rgba(255,255,255,0.04)}
    .close{float:right;background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:18px}
    pre{white-space:pre-wrap;background:#02121b;padding:12px;border-radius:8px;color:#dbeafb;font-size:13px;overflow:auto}
    .actions{display:flex;gap:8px;margin-top:10px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>Card Browser — search & display</h1>
    <div class="muted" style="margin-left:8px;font-size:13px">Load your JSON file or paste it below</div>
  </header>

  <div class="container">
    <aside class="left">
      <div>
        <label>Load JSON file</label>
        <input id="fileInput" type="file" accept=".json" />
        <div class="file-info" id="fileInfo">No file loaded</div>

        <label>Or paste JSON here</label>
        <textarea id="pasteInput" rows="6" placeholder='Paste JSON (object with "cards" array)'></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loadPaste">Parse pasted JSON</button>
          <button id="clearData" style="background:#a3a3a3;color:#02121b">Clear</button>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <label>Quick search (searches selected field or all fields)</label>
      <div class="controls">
        <select id="fieldSelect" title="Field to search">
          <option value="__any">Any field</option>
          <option value="name">name</option>
          <option value="fullName">fullName</option>
          <option value="simpleName">simpleName</option>
          <option value="fullText">fullText</option>
          <option value="color">color</option>
          <option value="type">type</option>
          <option value="rarity">rarity</option>
          <option value="setCode">setCode</option>
        </select>
        <input id="query" type="text" placeholder="Search text (supports regex if starts with /.../)" />
      </div>

      <label>Numeric filters</label>
      <div style="display:flex;gap:8px">
        <input id="minCost" type="number" placeholder="min cost" />
        <input id="maxCost" type="number" placeholder="max cost" />
      </div>

      <label>Advanced filters</label>
      <div style="display:flex;gap:8px">
        <select id="colorFilter">
          <option value="">Any color</option>
          <option>Amber</option><option>Sapphire</option><option>Ruby</option><option>Steel</option><option>Amber-Sapphire</option>
        </select>
        <select id="rarityFilter">
          <option value="">Any rarity</option>
          <option>Common</option><option>Uncommon</option><option>Rare</option><option>Super Rare</option><option>Legendary</option><option>Enchanted</option><option>Epic</option>
        </select>
      </div>

      <label style="margin-top:10px">Controls</label>
      <div class="actions">
        <button id="searchBtn">Search</button>
        <button id="resetFilters" style="background:#a3a3a3;color:#02121b">Reset</button>
        <button id="exportCsv" style="background:#10b981;color:#02241a">Export CSV</button>
      </div>

      <div class="footer">
        <div id="count" class="muted">0 cards</div>
        <div id="loadedSource" class="muted">—</div>
      </div>
    </aside>

    <main class="right">
      <div id="resultsTop" style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:14px">Results</div>
        <div class="muted" id="timeInfo"></div>
      </div>

      <div id="results" class="result-list"></div>

      <div id="loadMoreWrap" style="text-align:center;margin-top:10px;display:none">
        <button id="loadMore">Load more</button>
      </div>
    </main>
  </div>

  <!-- modal -->
  <div class="modal" id="modal">
    <div class="dialog">
      <button class="close" id="closeModal">✕</button>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
(function(){
  let data = null;
  let cards = [];
  let lastResults = [];
  let shown = 0;
  const PAGE_SIZE = 60;

  const $ = id => document.getElementById(id);
  const fileInput = $('fileInput');
  const pasteInput = $('pasteInput');
  const loadPaste = $('loadPaste');
  const fileInfo = $('fileInfo');
  const loadedSource = $('loadedSource');
  const queryEl = $('query');
  const fieldSelect = $('fieldSelect');
  const minCost = $('minCost');
  const maxCost = $('maxCost');
  const colorFilter = $('colorFilter');
  const rarityFilter = $('rarityFilter');
  const searchBtn = $('searchBtn');
  const resetFilters = $('resetFilters');
  const results = $('results');
  const count = $('count');
  const modal = $('modal');
  const modalBody = $('modalBody');
  const closeModal = $('closeModal');
  const exportCsv = $('exportCsv');
  const loadMore = $('loadMore');
  const loadMoreWrap = $('loadMoreWrap');
  const timeInfo = $('timeInfo');

  function parseAndLoad(obj, sourceLabel){
    data = obj;
    // find cards array
    if (Array.isArray(obj)) {
      cards = obj;
    } else if (obj.cards && Array.isArray(obj.cards)) {
      cards = obj.cards;
    } else if (obj.data && obj.data.cards && Array.isArray(obj.data.cards)) {
      cards = obj.data.cards;
    } else {
      // try to find a top-level array property
      let found = null;
      for (const k of Object.keys(obj)){
        if (Array.isArray(obj[k])){ found = obj[k]; break; }
      }
      cards = found || [];
    }

    fileInfo.textContent = `${cards.length} cards loaded`;
    loadedSource.textContent = sourceLabel || 'local';
    count.textContent = `${cards.length} cards`;
    timeInfo.textContent = new Date().toLocaleString();
    // reset shown
    shown = 0;
    lastResults = cards;
    renderResults(cards);
  }

  fileInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    fileInfo.textContent = `Loading ${f.name}...`;
    const fr = new FileReader();
    fr.onload = (evt)=>{
      try {
        const obj = JSON.parse(evt.target.result);
        parseAndLoad(obj, f.name);
      } catch (err){
        alert('Error parsing JSON: ' + err.message);
        fileInfo.textContent = 'Failed to parse';
      }
    };
    fr.readAsText(f);
  });

  loadPaste.addEventListener('click', ()=>{
    const txt = pasteInput.value.trim();
    if (!txt) return alert('Paste JSON first');
    try {
      const obj = JSON.parse(txt);
      parseAndLoad(obj, 'pasted JSON');
    } catch (err) {
      alert('Invalid JSON: ' + err.message);
    }
  });

  function matchCard(card, q, field){
    if (!q) return true;
    q = q.trim();
    // regex?
    if (q.startsWith('/') && q.endsWith('/')){
      try {
        const re = new RegExp(q.slice(1,-1),'i');
        if (field === '__any') {
          return JSON.stringify(card).search(re) !== -1;
        } else {
          const val = getFieldValue(card, field);
          return val !== null && String(val).search(re) !== -1;
        }
      } catch(e){
        // invalid regex -> fallback to text
      }
    }
    // simple contains
    const lower = q.toLowerCase();
    if (field === '__any'){
      return JSON.stringify(card).toLowerCase().indexOf(lower) !== -1;
    } else {
      const val = getFieldValue(card, field);
      if (val === null || val === undefined) return false;
      if (Array.isArray(val)) return val.join(' ').toLowerCase().includes(lower);
      return String(val).toLowerCase().includes(lower);
    }
  }

  function getFieldValue(card, field){
    if (!card) return null;
    // support nested with dot notation if ever needed
    if (field.includes('.')){
      const parts = field.split('.');
      let cur = card;
      for (const p of parts){
        if (!cur) return null;
        cur = cur[p];
      }
      return cur;
    }
    return card[field] ?? null;
  }

  function filterCards(){
    if (!cards) return [];
    const q = queryEl.value || '';
    const field = fieldSelect.value || '__any';
    const min = minCost.value !== '' ? Number(minCost.value) : null;
    const max = maxCost.value !== '' ? Number(maxCost.value) : null;
    const color = colorFilter.value || '';
    const rarity = rarityFilter.value || '';

    let out = cards.filter(c=>{
      if (!matchCard(c,q,field)) return false;
      if (min !== null){
        const cval = (c.cost!=null? c.cost : (c.cost === 0? 0 : null));
        if (cval === null) return false;
        if (cval < min) return false;
      }
      if (max !== null){
        const cval = (c.cost!=null? c.cost : (c.cost === 0? 0 : null));
        if (cval === null) return false;
        if (cval > max) return false;
      }
      if (color && String((c.color||c.colors||'')).indexOf(color)===-1) return false;
      if (rarity && String(c.rarity||'').toLowerCase() !== rarity.toLowerCase()) return false;
      return true;
    });
    return out;
  }

  function renderResults(list){
    lastResults = list || [];
    results.innerHTML = '';
    count.textContent = `${lastResults.length} cards`;
    shown = 0;
    if (lastResults.length === 0){
      results.innerHTML = '<div class="muted">No results</div>';
      loadMoreWrap.style.display='none';
      return;
    }
    renderMore();
  }

  function renderMore(){
    const end = Math.min(shown + PAGE_SIZE, lastResults.length);
    for (let i=shown;i<end;i++){
      const c = lastResults[i];
      const el = document.createElement('div');
      el.className = 'card';
      el.dataset.index = i;
      const thumbUrl = (c.images && (c.images.thumbnail || c.images.full)) || '';
      el.innerHTML = `
        <div class="thumb">${ thumbUrl ? `<img src="${thumbUrl}" loading="lazy" alt="${escapeHtml(c.fullName||c.name||'card')}" />` : '<div class="muted">no image</div>'}</div>
        <div class="meta">
          <h3>${escapeHtml(c.fullName || c.name || c.simpleName || '—')}</h3>
          <p class="muted">${escapeHtml(c.type || '')} • ${escapeHtml(c.setCode||'')} #${escapeHtml(String(c.number||''))}</p>
          <div class="stats">
            ${c.color ? `<div class="pill">${escapeHtml(c.color)}</div>` : ''}
            ${c.cost != null ? `<div class="pill">cost ${escapeHtml(String(c.cost))}</div>` : ''}
            ${c.rarity ? `<div class="pill">${escapeHtml(c.rarity)}</div>` : ''}
          </div>
        </div>
      `;
      el.addEventListener('click', ()=> showCardModal(c));
      results.appendChild(el);
    }
    shown = end;
    loadMoreWrap.style.display = shown < lastResults.length ? 'block' : 'none';
  }

  loadMore.addEventListener('click', ()=> renderMore());

  function showCardModal(card){
    modalBody.innerHTML = '';
    const img = (card.images && (card.images.full || card.images.thumbnail)) || '';
    const title = card.fullName || card.name || card.simpleName || 'Card';
    const top = document.createElement('div');
    top.style.display='flex';
    top.style.gap='12px';
    top.style.alignItems='flex-start';
    top.innerHTML = `
      <div style="width:220px">
        ${ img ? `<img src="${img}" style="width:100%;height:auto;border-radius:8px;display:block" />` : '<div class="muted">No image</div>'}
      </div>
      <div style="flex:1">
        <h2 style="margin:0">${escapeHtml(title)}</h2>
        <div class="muted" style="margin-bottom:10px">${escapeHtml((card.type||'') + (card.version ? ' • ' + card.version : ''))}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${card.color ? `<div class="pill">${escapeHtml(card.color)}</div>` : ''}
          ${card.cost!=null ? `<div class="pill">cost ${escapeHtml(String(card.cost))}</div>` : ''}
          ${card.rarity ? `<div class="pill">${escapeHtml(card.rarity)}</div>` : ''}
          ${card.setCode ? `<div class="pill">set ${escapeHtml(card.setCode)}</div>` : ''}
        </div>
        <div style="margin-top:10px">
          <strong>Story:</strong> <span class="muted">${escapeHtml(card.story||'')}</span>
        </div>
      </div>
    `;
    modalBody.appendChild(top);

    const j = document.createElement('pre');
    j.textContent = JSON.stringify(card, null, 2);
    modalBody.appendChild(j);
    modal.style.display = 'flex';
  }

  closeModal.addEventListener('click', ()=> modal.style.display='none');
  modal.addEventListener('click', (e)=> { if (e.target === modal) modal.style.display='none'; });

  function escapeHtml(s){
    if (s === null || s === undefined) return '';
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  searchBtn.addEventListener('click', ()=>{
    const res = filterCards();
    renderResults(res);
  });

  resetFilters.addEventListener('click', ()=>{
    queryEl.value=''; fieldSelect.value='__any'; minCost.value=''; maxCost.value=''; colorFilter.value=''; rarityFilter.value='';
    if (!cards) return;
    renderResults(cards);
  });

  // quick trigger: enter in search field
  queryEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') searchBtn.click(); });

  exportCsv.addEventListener('click', ()=>{
    if (!lastResults || lastResults.length===0) return alert('No results to export');
    // convert to CSV with selected fields
    const fields = ['id','fullName','name','simpleName','setCode','number','cost','color','rarity','type'];
    const rows = [fields.join(',')];
    for (const c of lastResults){
      const vals = fields.map(f=>{
        const v = c[f] ?? '';
        // stringify arrays
        if (Array.isArray(v)) return '"' + String(v.join('; ')).replace(/"/g,'""') + '"';
        return '"' + String(v).replace(/"/g,'""') + '"';
      });
      rows.push(vals.join(','));
    }
    const blob = new Blob([rows.join('\\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cards_export.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Allow dragging JSON text into textarea
  pasteInput.addEventListener('drop', (ev)=>{
    ev.preventDefault();
    const f = ev.dataTransfer.files && ev.dataTransfer.files[0];
    if (f){
      const fr = new FileReader();
      fr.onload = ()=> pasteInput.value = fr.result;
      fr.readAsText(f);
    } else {
      const t = ev.dataTransfer.getData('text');
      pasteInput.value = t;
    }
  });
  pasteInput.addEventListener('dragover', (ev)=> ev.preventDefault());

  // helpful: try auto-loading file via fetch if page hosted next to JSON (works when you place JSON and this HTML in same folder and serve via http)
  async function tryAutoLoad(){
    try {
      const url = './allCards.json';
      const resp = await fetch(url, {cache:'no-store'});
      if (!resp.ok) return;
      const obj = await resp.json();
      parseAndLoad(obj, 'allCards.json (auto-loaded)');
    } catch(e){
      // ignore
    }
  }
  // try auto load (only works when served from same folder)
  tryAutoLoad();

})();
</script>
</body>
</html>
